generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String
  createdAt    DateTime @default(now())

  subscriptions Subscription[]
  payments      Payment[]
  agent         Agent?
}

enum Plan {
  Hosting
  Complet
}

enum SubscriptionStatus {
  active
  cancelled
  past_due
}

model Subscription {
  id                    String             @id @default(cuid())
  userId                String
  plan                  Plan
  status                SubscriptionStatus
  stripeSubscriptionId   String?            @unique
  stripeCustomerId      String?
  currentPeriodEnd      DateTime?
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

enum PaymentStatus {
  succeeded
  pending
  failed
}

model Payment {
  id                   String        @id @default(cuid())
  userId               String
  amount               Int
  status               PaymentStatus
  stripePaymentIntentId String?
  stripeInvoiceId      String?
  createdAt            DateTime      @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

enum AgentStatus {
  starting
  running
  stopped
  error
}

model Agent {
  id           String      @id @default(cuid())
  userId       String      @unique
  containerId  String?
  status       AgentStatus @default(stopped)
  port         Int?
  volumePath   String?
  qrCodePath   String?
  errorMessage String?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  skills AgentSkill[]
  config AgentConfig?
}

model Skill {
  id             String   @id @default(cuid())
  name           String
  description    String
  slug           String   @unique
  defaultEnabled Boolean  @default(false)
  category       String   @default("General")
  icon           String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  agents AgentSkill[]
}

model AgentSkill {
  agentId   String
  skillId   String
  enabled   Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  agent Agent @relation(fields: [agentId], references: [id], onDelete: Cascade)
  skill Skill @relation(fields: [skillId], references: [id], onDelete: Cascade)

  @@id([agentId, skillId])
}

model AgentConfig {
  id        String   @id @default(cuid())
  agentId   String   @unique
  envVars   Json     @default("{}")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  agent Agent @relation(fields: [agentId], references: [id], onDelete: Cascade)
}
